{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
<!-- MediaPipe dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<div class="relative w-full h-screen bg-black flex flex-col items-center justify-center overflow-hidden"
    id="presentation-container">

    <!-- Slides Container -->
    <div id="slides-wrapper" class="w-full h-full flex items-center justify-center p-0">
        {% for slide_url in slides %}
        <img src="{{ slide_url }}"
            class="slide absolute max-w-full max-h-full object-contain transition-opacity duration-500 {% if forloop.first %}opacity-100{% else %}opacity-0{% endif %}"
            data-index="{{ forloop.counter0 }}">
        {% endfor %}
    </div>

    <!-- Control Bar - Bottom Center (Auto-hide) -->
    <div id="ui-overlay" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 z-50 transition-all duration-500">
        <div class="flex items-center gap-2 bg-black/80 backdrop-blur-xl px-6 py-4 rounded-full shadow-2xl border border-white/10 hover:border-white/20 transition-colors">
            
            <!-- Previous Button -->
            <button id="prev-btn"
                class="relative w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br from-orange-500 to-orange-600 text-white hover:from-orange-600 hover:to-orange-700 transition-all duration-300 hover:scale-110 shadow-lg hover:shadow-orange-500/50 group active:scale-95">
                <i class="fas fa-chevron-left text-base"></i>
                <span class="absolute -top-14 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none z-50 font-medium">Anterior</span>
            </button>

            <!-- Slide Counter -->
            <div class="relative w-12 h-12 rounded-full flex items-center justify-center bg-white/10 border border-white/20 text-white font-bold text-sm shadow-lg group hover:bg-white/20 transition-colors">
                <span id="current-slide">1</span>
                <span class="absolute -top-14 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none z-50 font-medium">
                    <span id="current-slide-tooltip">1</span>/<span id="total-slides-tooltip">{{ slides|length }}</span>
                </span>
            </div>

            <!-- Next Button -->
            <button id="next-btn"
                class="relative w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 transition-all duration-300 hover:scale-110 shadow-lg hover:shadow-blue-500/50 group active:scale-95">
                <i class="fas fa-chevron-right text-base"></i>
                <span class="absolute -top-14 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none z-50 font-medium">Siguiente</span>
            </button>

            <!-- Divider -->
            <div class="w-px h-8 bg-white/10 mx-2"></div>

            <!-- Camera Toggle -->
            <button id="camera-toggle-btn"
                class="relative w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br from-green-500 to-green-600 text-white hover:from-green-600 hover:to-green-700 transition-all duration-300 hover:scale-110 shadow-lg hover:shadow-green-500/50 group active:scale-95"
                data-camera-active="true">
                <i class="fas fa-video text-base"></i>
                <span class="absolute -top-14 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none z-50 font-medium">Gestos ON</span>
            </button>

            <!-- PiP Toggle -->
            <button id="toggle-camera-btn"
                class="relative w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br from-purple-500 to-purple-600 text-white hover:from-purple-600 hover:to-purple-700 transition-all duration-300 hover:scale-110 shadow-lg hover:shadow-purple-500/50 group active:scale-95">
                <i class="fas fa-eye text-base"></i>
                <span class="absolute -top-14 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none z-50 font-medium">C√°mara</span>
            </button>

            <!-- Fullscreen -->
            <button id="fullscreen-btn"
                class="relative w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br from-cyan-500 to-cyan-600 text-white hover:from-cyan-600 hover:to-cyan-700 transition-all duration-300 hover:scale-110 shadow-lg hover:shadow-cyan-500/50 group active:scale-95">
                <i class="fas fa-expand text-base"></i>
                <span class="absolute -top-14 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none z-50 font-medium">Pantalla Completa</span>
            </button>

            <!-- Exit -->
            <a href="{% url 'core:dashboard' %}"
                class="relative w-12 h-12 rounded-full flex items-center justify-center bg-gradient-to-br from-red-500 to-red-600 text-white hover:from-red-600 hover:to-red-700 transition-all duration-300 hover:scale-110 shadow-lg hover:shadow-red-500/50 group active:scale-95">
                <i class="fas fa-times text-base"></i>
                <span class="absolute -top-14 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none z-50 font-medium">Salir</span>
            </a>
        </div>
    </div>

    <!-- Invisible Camera Elements -->
    <video id="input-video" class="hidden" playsinline></video>

    <!-- PiP Camera View - Hidden by default -->
    <div id="pip-camera"
        class="absolute top-6 left-6 w-72 h-56 bg-black border-2 border-cyan-400/50 rounded-xl shadow-2xl z-50 overflow-hidden hover:border-cyan-400 transition-colors duration-300 group hidden">
        <canvas id="output-canvas" class="w-full h-full"></canvas>
        <!-- Indicator -->
        <div class="absolute top-3 right-3 flex items-center gap-2 bg-black/70 px-3 py-1.5 rounded-full text-xs text-cyan-300 font-semibold">
            <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
            LIVE
        </div>
    </div>

    <!-- Tutorial Modal - Redise√±ado Premium -->
    <div id="tutorial-modal"
        class="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md">
        <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl max-w-3xl w-full shadow-2xl border border-cyan-400/30 mx-4 relative overflow-hidden">
            
            <!-- Animated Background Gradient -->
            <div class="absolute inset-0 bg-gradient-to-br from-cyan-500/5 to-blue-500/5 pointer-events-none"></div>
            
            <!-- Header con l√≠nea de gradiente -->
            <div class="relative h-1 bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-500"></div>
            
            <div class="relative p-8">
                <!-- T√≠tulo con icono -->
                <div class="text-center mb-2">
                    <h2 class="text-4xl font-black bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent mb-2">
                        <i class="fas fa-hand-sparkles mr-3"></i>Control GESVA
                    </h2>
                    <p class="text-gray-400 text-sm">Domina tu presentaci√≥n con gestos intuitivos</p>
                </div>

                <!-- Grid de 4 gestos principales -->
                <div class="grid grid-cols-2 gap-4 mb-6 mt-6">
                    <!-- Pu√±o Izquierdo - PAUSA -->
                    <div class="group bg-gradient-to-br from-red-500/10 to-red-600/5 border border-red-400/30 rounded-xl p-4 hover:border-red-400/60 hover:bg-red-500/15 transition-all duration-300 cursor-pointer">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center mr-3 group-hover:bg-red-500/30 transition-colors">
                                <i class="fas fa-hand-fist text-red-400 text-lg"></i>
                            </div>
                            <h3 class="font-bold text-red-300 text-sm">Pu√±o Izquierdo</h3>
                        </div>
                        <p class="text-xs text-gray-400 leading-relaxed">Pausa los gestos para hablar sin interrupciones</p>
                    </div>

                    <!-- Pu√±o Derecho - REANUDA -->
                    <div class="group bg-gradient-to-br from-green-500/10 to-green-600/5 border border-green-400/30 rounded-xl p-4 hover:border-green-400/60 hover:bg-green-500/15 transition-all duration-300 cursor-pointer">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center mr-3 group-hover:bg-green-500/30 transition-colors">
                                <i class="fas fa-hand-fist text-green-400 text-lg"></i>
                            </div>
                            <h3 class="font-bold text-green-300 text-sm">Pu√±o Derecho</h3>
                        </div>
                        <p class="text-xs text-gray-400 leading-relaxed">Reanuda los gestos para continuar controlando</p>
                    </div>

                    <!-- Mano Derecha - SIGUIENTE -->
                    <div class="group bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-400/30 rounded-xl p-4 hover:border-blue-400/60 hover:bg-blue-500/15 transition-all duration-300 cursor-pointer">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center mr-3 group-hover:bg-blue-500/30 transition-colors">
                                <i class="fas fa-hand text-blue-400 text-lg"></i>
                            </div>
                            <h3 class="font-bold text-blue-300 text-sm">Mano Derecha</h3>
                        </div>
                        <p class="text-xs text-gray-400 leading-relaxed">Desliza hacia la derecha para siguiente slide</p>
                    </div>

                    <!-- Mano Izquierda - ANTERIOR -->
                    <div class="group bg-gradient-to-br from-amber-500/10 to-amber-600/5 border border-amber-400/30 rounded-xl p-4 hover:border-amber-400/60 hover:bg-amber-500/15 transition-all duration-300 cursor-pointer">
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center mr-3 group-hover:bg-amber-500/30 transition-colors">
                                <i class="fas fa-hand text-amber-400 text-lg"></i>
                            </div>
                            <h3 class="font-bold text-amber-300 text-sm">Mano Izquierda</h3>
                        </div>
                        <p class="text-xs text-gray-400 leading-relaxed">Desliza hacia la izquierda para slide anterior</p>
                    </div>
                </div>

                <!-- Info Box con tips -->
                <div class="bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border border-cyan-400/30 rounded-xl p-4 mb-6">
                    <div class="flex gap-3">
                        <div class="text-cyan-400 text-lg flex-shrink-0">üí°</div>
                        <div>
                            <p class="text-sm font-semibold text-cyan-300 mb-1">Consejo Pro:</p>
                            <p class="text-xs text-gray-400 leading-relaxed">Comienza con pu√±o izquierdo para pausar, realiza tus gestos, luego pu√±o derecho para reanudar. Esto evita cambios accidentales.</p>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n inicio prominente -->
                <button id="start-btn"
                    class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold py-4 rounded-xl transition-all duration-300 transform hover:scale-[1.02] active:scale-95 shadow-lg hover:shadow-cyan-500/50 text-base flex items-center justify-center gap-2">
                    <i class="fas fa-play"></i>
                    Iniciar Presentaci√≥n
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="module" src="{% static 'js/GestureProcessor.js' %}"></script>
<script type="module" src="{% static 'js/SlideManager.js' %}"></script>
<script>
    // DEBUG SCRIPT - Verificar que todo est√° cargado
    window.addEventListener('load', () => {
        console.log('=== SYSTEM CHECK ===');
        console.log('‚úì GestureProcessor:', !!window.gestureProcessor);
        console.log('‚úì SlideManager:', !!window.slideManager);
        console.log('‚úì camera-toggle-btn:', !!document.getElementById('camera-toggle-btn'));
        
        if (window.gestureProcessor) {
            console.log('‚úì triggerCameraToggle method:', typeof window.gestureProcessor.triggerCameraToggle);
        }
    });
    
    // Funci√≥n de test manual - llamar desde consola
    window.testCameraOn = () => {
        if (window.gestureProcessor) {
            window.gestureProcessor.triggerCameraToggle('üé• TEST C√ÅMARA ON', true);
        }
    };
    window.testCameraOff = () => {
        if (window.gestureProcessor) {
            window.gestureProcessor.triggerCameraToggle('‚ùå TEST C√ÅMARA OFF', false);
        }
    };
</script>
{% endblock %}
